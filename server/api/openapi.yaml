openapi: 3.1.0
info:
  title: doc-thor server API
  description: >
    Core API for doc-thor. Manages documentation projects, build jobs,
    published versions, authentication, and backend discovery.
  version: 1.0.0

servers:
  - url: /api/v1

# ---------------------------------------------------------------------------
# Security
# ---------------------------------------------------------------------------
# All endpoints except GET /health and POST /auth/login require a Bearer
# token.  The token is either a session token (returned by /auth/login) or
# an API key (created via POST /auth/apikey).  Both are validated the same
# way; only the raw value is ever sent over the wire â€” the server stores
# only its SHA-256 hash.
# ---------------------------------------------------------------------------
security:
  - bearerToken: []

components:
  securitySchemes:
    bearerToken:
      type: http
      scheme: bearer
      description: Session token from POST /auth/login or an API key from POST /auth/apikey.

  # -----------------------------------------------------------------
  # Reusable schemas
  # -----------------------------------------------------------------
  schemas:
    # --- common ---
    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          example: project not found

    # --- Project ---
    Project:
      type: object
      required:
        - id
        - slug
        - name
        - source_url
        - docker_image
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          format: uint
        slug:
          type: string
        name:
          type: string
        source_url:
          type: string
        docker_image:
          type: string
          description: >
            Docker image the builder will run for this project.  The image
            must follow the builder contract: source repo is mounted
            read-only at /repo, generated output must be written to /output.
          example: doc-thor/builder-mkdocs
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ProjectCreate:
      type: object
      required:
        - slug
        - name
        - source_url
        - docker_image
      properties:
        slug:
          type: string
          example: my-docs
        name:
          type: string
          example: My Documentation
        source_url:
          type: string
          example: https://github.com/org/my-docs.git
        docker_image:
          type: string
          example: doc-thor/builder-mkdocs

    ProjectUpdate:
      description: >
        All fields are optional.  Only fields that are present and
        non-empty are applied.  Omit a field to leave it unchanged.
      type: object
      properties:
        name:
          type: string
        source_url:
          type: string
        docker_image:
          type: string

    # --- Build ---
    Build:
      type: object
      required:
        - id
        - project_id
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          format: uint
        project_id:
          type: integer
          format: uint
        ref:
          type: string
          description: Git ref that was built. Empty string when the builder uses the default branch.
        status:
          type: string
          enum: [pending, running, success, failed]
        logs:
          type: string
          description: Accumulated build log output.  Present only when non-empty.
        started_at:
          type: string
          format: date-time
          nullable: true
        finished_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    BuildCreate:
      type: object
      properties:
        ref:
          type: string
          description: >
            Git ref (branch, tag, or SHA) to build.  Omit or send an
            empty body to build the repository's default branch.
          example: main

    # --- Version ---
    Version:
      type: object
      required:
        - id
        - project_id
        - build_id
        - version
        - published
        - is_latest
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          format: uint
        project_id:
          type: integer
          format: uint
        build_id:
          type: integer
          format: uint
        version:
          type: string
          description: The version tag (maps to the URL-visible version segment).
        published:
          type: boolean
        is_latest:
          type: boolean
          description: >
            When true this version is served at the bare subdomain
            (without a version segment).  At most one version per
            project may be latest; setting it here clears the flag
            on any previous latest.
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    VersionUpdate:
      type: object
      description: >
        At least one field must be provided; an empty body returns 400.
      properties:
        published:
          type: boolean
        is_latest:
          type: boolean

    # --- Auth ---
    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          example: admin
        password:
          type: string
          format: password
          example: s3cret

    LoginResponse:
      type: object
      required:
        - token
      properties:
        token:
          type: string
          description: Opaque session token.  Use as a Bearer value.

    APIKeyCreate:
      type: object
      properties:
        label:
          type: string
          description: Human-readable label for the key.
          example: ci-pipeline

    APIKeyResponse:
      type: object
      required:
        - key
        - label
      properties:
        key:
          type: string
          description: >
            Raw API key.  Only returned once at creation time.
            The server never stores or exposes this value again.
        label:
          type: string

    User:
      type: object
      required:
        - id
        - username
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          format: uint
        username:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    # --- Discovery ---
    BackendStatus:
      type: object
      required:
        - name
        - url
        - healthy
        - last_check
      properties:
        name:
          type: string
          enum: [builder, storage]
        url:
          type: string
        healthy:
          type: boolean
        last_check:
          type: string
          format: date-time

    # --- VCS Integration ---
    VCSIntegration:
      type: object
      required:
        - id
        - name
        - provider
        - instance_url
        - enabled
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          format: uint
        name:
          type: string
          description: Unique identifier for this VCS integration (e.g., "company-gitlab")
          example: company-gitlab
        provider:
          type: string
          enum: [gitlab, github, gitea]
        instance_url:
          type: string
          description: Base URL of the VCS instance
          example: https://gitlab.company.com
        enabled:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    VCSIntegrationCreate:
      type: object
      required:
        - name
        - provider
        - instance_url
        - access_token
        - webhook_secret
      properties:
        name:
          type: string
          example: company-gitlab
        provider:
          type: string
          enum: [gitlab, github, gitea]
        instance_url:
          type: string
          example: https://gitlab.company.com
        access_token:
          type: string
          description: API token for accessing the VCS platform
        webhook_secret:
          type: string
          description: Secret for validating webhook signatures
        enabled:
          type: boolean
          default: true

    VCSIntegrationUpdate:
      type: object
      properties:
        provider:
          type: string
          enum: [gitlab, github, gitea]
        instance_url:
          type: string
        access_token:
          type: string
        webhook_secret:
          type: string
        enabled:
          type: boolean

    DiscoveryRequest:
      type: object
      required:
        - scope
      properties:
        scope:
          type: string
          description: VCS scope to scan (e.g., GitLab group path)
          example: myteam/docs

    DiscoveredProject:
      type: object
      required:
        - name
        - path
        - clone_url
        - default_branch
        - has_doc_thor
      properties:
        name:
          type: string
        path:
          type: string
          description: Full repository path in VCS
          example: myteam/docs/api-docs
        clone_url:
          type: string
        default_branch:
          type: string
        has_doc_thor:
          type: boolean
        doc_thor_config:
          $ref: "#/components/schemas/DocThorConfig"

    DocThorConfig:
      type: object
      required:
        - slug
        - name
        - docker_image
      properties:
        slug:
          type: string
        name:
          type: string
        docker_image:
          type: string
        branch_mappings:
          type: array
          items:
            $ref: "#/components/schemas/BranchMapping"

    BranchMapping:
      type: object
      required:
        - branch
        - version_tag
      properties:
        branch:
          type: string
          description: Branch/tag pattern (supports glob)
          example: main
        version_tag:
          type: string
          description: Target version tag (supports ${branch} and ${tag} variables)
          example: latest
        auto_publish:
          type: boolean
          default: false

    ImportProjectRequest:
      type: object
      required:
        - integration_name
        - discovered_project
      properties:
        integration_name:
          type: string
        discovered_project:
          $ref: "#/components/schemas/DiscoveredProject"
        branch_mappings:
          type: array
          items:
            $ref: "#/components/schemas/BranchMapping"
        auto_publish:
          type: boolean
          description: Override auto_publish for all branch mappings
        register_webhook:
          type: boolean
          default: false
        callback_url:
          type: string
          description: Webhook callback URL (required if register_webhook is true)

  # -----------------------------------------------------------------
  # Reusable responses
  # -----------------------------------------------------------------
  responses:
    Unauthorized:
      description: Missing or invalid Bearer token.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: unauthorized

    NotFound:
      description: The requested resource does not exist.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

    BadRequest:
      description: Malformed or invalid request.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

    InternalError:
      description: Unexpected server error.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: database error

# ---------------------------------------------------------------------------
# Paths
# ---------------------------------------------------------------------------
paths:
  # -----------------------------------------------------------------------
  # Health
  # -----------------------------------------------------------------------
  /health:
    get:
      summary: Liveness check
      operationId: health
      security: []   # public
      responses:
        "200":
          description: Server is running.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ok]
              example:
                status: ok

  # -----------------------------------------------------------------------
  # Auth
  # -----------------------------------------------------------------------
  /auth/login:
    post:
      summary: Authenticate and obtain a session token
      operationId: login
      security: []   # public
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Credentials accepted.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: Invalid username or password.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error: invalid credentials

  /auth/apikey:
    post:
      summary: Create an API key
      operationId: createAPIKey
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/APIKeyCreate"
      responses:
        "201":
          description: Key created.  The raw key is included only in this response.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIKeyResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/me:
    get:
      summary: Return the authenticated user
      operationId: getMe
      responses:
        "200":
          description: Current user.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          $ref: "#/components/responses/Unauthorized"

  # -----------------------------------------------------------------------
  # Projects
  # -----------------------------------------------------------------------
  /projects:
    post:
      summary: Create a project
      operationId: createProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProjectCreate"
      responses:
        "201":
          description: Project created.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"
        "400":
          description: Missing required field (slug, name, source_url, or docker_image).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error: slug, name, source_url, and docker_image are required
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: A project with this slug already exists.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error: project with this slug already exists
        "500":
          $ref: "#/components/responses/InternalError"

    get:
      summary: List all projects
      operationId: listProjects
      responses:
        "200":
          description: Array of projects (may be empty).
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Project"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /projects/{slug}:
    parameters:
      - name: slug
        in: path
        required: true
        schema:
          type: string
        description: Unique project identifier.

    get:
      summary: Get a single project
      operationId: getProject
      responses:
        "200":
          description: The requested project.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    put:
      summary: Update a project
      operationId: updateProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProjectUpdate"
      responses:
        "200":
          description: Updated project.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      summary: Delete a project and all its builds and versions
      operationId: deleteProject
      responses:
        "204":
          description: Project deleted. No content returned.
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  # -----------------------------------------------------------------------
  # Builds
  # -----------------------------------------------------------------------
  /projects/{slug}/builds:
    parameters:
      - name: slug
        in: path
        required: true
        schema:
          type: string

    post:
      summary: Trigger a build
      operationId: createBuild
      requestBody:
        required: false
        description: Body may be omitted entirely to build the default branch.
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BuildCreate"
      responses:
        "201":
          description: Build job created with status `pending`.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Build"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Project not found.
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    get:
      summary: List builds for a project
      operationId: listBuilds
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
          description: Maximum number of builds to return.
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
          description: Number of builds to skip (for pagination).
      responses:
        "200":
          description: Builds ordered by created_at descending.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Build"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /projects/{slug}/builds/{id}:
    parameters:
      - name: slug
        in: path
        required: true
        schema:
          type: string
      - name: id
        in: path
        required: true
        schema:
          type: integer
          format: uint
        description: Build ID.

    get:
      summary: Get a single build
      operationId: getBuild
      responses:
        "200":
          description: The requested build, including logs if available.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Build"
        "400":
          description: The build id path segment is not a valid integer.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error: invalid build id
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  # -----------------------------------------------------------------------
  # Versions
  # -----------------------------------------------------------------------
  /projects/{slug}/versions:
    parameters:
      - name: slug
        in: path
        required: true
        schema:
          type: string

    get:
      summary: List versions for a project
      operationId: listVersions
      responses:
        "200":
          description: All versions for the project (published and unpublished).
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Version"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /projects/{slug}/versions/{ver}:
    parameters:
      - name: slug
        in: path
        required: true
        schema:
          type: string
      - name: ver
        in: path
        required: true
        schema:
          type: string
        description: Version tag.

    put:
      summary: Update version metadata
      description: >
        Publish, unpublish, or promote a version to latest.
        After a successful update the server performs a best-effort
        sync of the Nginx routing configuration; that sync failure
        does not cause this request to fail.
      operationId: updateVersion
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VersionUpdate"
      responses:
        "200":
          description: Updated version.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Version"
        "400":
          description: Body is missing or contains no recognised fields.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error: nothing to update
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  # -----------------------------------------------------------------------
  # System / Discovery
  # -----------------------------------------------------------------------
  /backends:
    get:
      summary: Discovered backend services and their health
      description: >
        Returns one entry per configured builder endpoint plus one
        entry for the storage backend.  Each entry reflects
        the result of the most recent health-check ping performed
        during this request.
      operationId: getBackends
      responses:
        "200":
          description: Backend statuses.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/BackendStatus"
        "401":
          $ref: "#/components/responses/Unauthorized"

  # -----------------------------------------------------------------------
  # VCS Integrations
  # -----------------------------------------------------------------------
  /integrations:
    post:
      summary: Create VCS integration
      operationId: createVCSIntegration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VCSIntegrationCreate"
      responses:
        "201":
          description: Integration created.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VCSIntegration"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: Integration with this name already exists.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          $ref: "#/components/responses/InternalError"

    get:
      summary: List all VCS integrations
      operationId: listVCSIntegrations
      responses:
        "200":
          description: Array of VCS integrations.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/VCSIntegration"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /integrations/{name}:
    parameters:
      - name: name
        in: path
        required: true
        schema:
          type: string

    get:
      summary: Get VCS integration details
      operationId: getVCSIntegration
      responses:
        "200":
          description: The requested integration.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VCSIntegration"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    put:
      summary: Update VCS integration
      operationId: updateVCSIntegration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VCSIntegrationUpdate"
      responses:
        "200":
          description: Updated integration.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VCSIntegration"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      summary: Delete VCS integration
      operationId: deleteVCSIntegration
      responses:
        "204":
          description: Integration deleted.
        "400":
          description: Cannot delete - projects are using this integration.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /integrations/{name}/test:
    parameters:
      - name: name
        in: path
        required: true
        schema:
          type: string

    post:
      summary: Test VCS integration connection
      operationId: testVCSIntegration
      responses:
        "200":
          description: Connection test result.
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  error:
                    type: string
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  # -----------------------------------------------------------------------
  # Project Discovery
  # -----------------------------------------------------------------------
  /integrations/{name}/discover:
    parameters:
      - name: name
        in: path
        required: true
        schema:
          type: string
        description: VCS integration name

    post:
      summary: Discover projects in VCS scope
      description: Scans the given VCS scope for projects with .doc-thor.project.yaml
      operationId: discoverProjects
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DiscoveryRequest"
      responses:
        "200":
          description: Discovered projects.
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                  projects:
                    type: array
                    items:
                      $ref: "#/components/schemas/DiscoveredProject"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Integration not found.
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /projects/import:
    post:
      summary: Import a discovered project
      description: Creates a project from discovery results and optionally registers webhook
      operationId: importProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ImportProjectRequest"
      responses:
        "201":
          description: Project imported.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Integration not found.
          $ref: "#/components/responses/NotFound"
        "409":
          description: Project with this slug already exists.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          $ref: "#/components/responses/InternalError"

  # -----------------------------------------------------------------------
  # Webhooks (Public endpoints - no authentication)
  # -----------------------------------------------------------------------
  /webhooks/{provider}/{slug}:
    parameters:
      - name: provider
        in: path
        required: true
        schema:
          type: string
          enum: [gitlab, github, gitea]
      - name: slug
        in: path
        required: true
        schema:
          type: string

    post:
      summary: Webhook receiver
      description: Receives webhooks from VCS platforms and triggers builds
      operationId: receiveWebhook
      security: []  # public - authenticated via webhook secret in headers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: VCS-specific webhook payload
      responses:
        "202":
          description: Webhook accepted and build triggered.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [accepted, ignored]
                  build_id:
                    type: integer
                  version_tag:
                    type: string
                  ref:
                    type: string
                  auto_publish:
                    type: boolean
        "400":
          description: Project not configured for webhooks or no matching branch mapping.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Invalid webhook signature.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Project not found.
          $ref: "#/components/responses/NotFound"
